# 红队攻击

* 情报收集

* 建立据点
* 横向移动
* 红队常用的四种攻击技术



## 情报收集 ##

收集的内容包括：

* IT资产
* 敏感信息泄露
* 供应商信息
* 单位
* 下属单位
* WEB中间件
* WEB应用
* 移动应用
* 网络架构
* 代码泄露
* 文档信息泄露
* 邮箱信息泄露
* 历史漏洞泄露
* 供应商相关合同信息
* 系统
* 软件
* 硬件
* 代码
* 服务
* 人员信息



掌握了目标企业相关人员信息和组织架构，可以快速定位关键人物以便实施鱼叉攻击，或确定内网横
纵向渗透路径；而收集了IT资产信息 。可以为漏洞发现和利用提供数据支撑；掌握企业与供应商合作相关信
息，可为有针对性开展供应链攻击提供素材。而究竟是要社工钓鱼，还是直接利用漏洞攻击，抑或是从供
应链下手，一般取决于哪块是安全防护的薄弱环节，以及红队对攻击路径的选择。 

![çº¢éä¿¡æ¯æ¶é](https://s2.ax1x.com/2019/08/22/mdDIkF.png)





## 建立据点 ##

找到薄弱环节后，红队专家会尝试利用漏洞或社工等方法去获取外网系统控制权限，一般称之为“打点”或撕口子。在这个过程中，红队专家会尝试绕过WAF、IPS、杀毒软件等防护设备或软件，用最少的流量、最小的动作去实现漏洞利用。通过撕开的口子，寻找和内网联通的通道，再进一步进行深入渗透，这个由外到内的过程一般称之为纵向渗透，如果没有找到内外联通的DMZ区（Demilitarized Zone，隔离区），红队专家会继续撕口子，直到找到接入内网的点为止 当红队专家找到合适的口子后，便 可 以 把这 个 点 作 为 从 外 网 进 入 内 网 的 根 据 地 。 通 过frp、ewsocks、reGeorg等工具在这个点上建立隧道，形成从外网到内网的跳板，将它作为实施内网渗透的坚实据点 ,若权限不足以建立跳板，红队专家通常会利用系统、程序或服务漏洞进行提权操作，以获得更高权限；若据点是非稳定的PC机，则会进行持久化操作，保证PC机重启后，据点依然可以在线。 

![](https://s2.ax1x.com/2019/08/22/md4EFI.png)

## 横向移动 ##

进入内网后，红队专家一般会在本机以及内部网络
开展进一步信息收集和情报刺探工作 

* 当前计算机的网络连接
* 进程列表 
* 命令执行历史记录 
* 数据库信息 
* 当前用户信息 
* 管理员登录信息 
* 总结密码规律  
* 补丁更新频率等信息 
* 同时对内网的其他计算机或服务器的IP、主机名、开放端口、开放服务、开放应用等情况进行情报刺探。再利用内网计算机、服务器不及时修复漏洞、不做安全防护、同口令等弱点来进行横向渗透扩大战果 



在内网漫游过程中，红队专家会重点关注邮件服务器权限、OA系统权限、版本控制服务器权限、集中运 维管理平台权限、统一认证系统权限、域控权限等位置，尝试突破核心系统权限、控制核心业务、获取核心数据，最终完成目标突破工作 

## 四种红队最常用的攻击战术  ##

<b>一、利用弱口令获得权限</b>
弱密码、默认密码、通用密码和已泄露密码通常是红队专家们关注的重点。实际工作中，通过脆弱口令
获得权限的情况占据90%以上。很多企业员工用类似zhangsan、zhangsan001、zhangsan123、zhangsan888这种账号拼音或其简单变形，或者123456、888888、生日、身份证后6位、手机号后6位等做密码。导致通过信息收集后，生成简单的密码字典进行枚举即可攻陷邮箱、OA等账号。 还有很多员工喜欢在多个不同网站上设置同一套密码，其密码早已经被泄露并录入到了社工库中；或者针对未启用SSO验证的内网业务系统，均习惯使用同一套账户密码。这导致从某一途径获取了其账户密码后，通过凭证复用的方式可以轻而易举地登录到此员工所使用的其他业务系统中，为打开新的攻击面提供了便捷 



很多通用系统在安装后会设置默认管理密码，
然而有些管理员从来没有修改过密码，如:

```
admin/admin、test/123456、admin/admin888
```

等密码广泛存在于内外网系统后台，一旦进入后台系统，便有很
大可能性获得服务器控制权限；同样，有很多管理员为了管理方便，用同一套密码管理不同服务器。当一
台服务器被攻陷并窃取到密码后，进而可以扩展至多台服务器甚至造成域控制器沦陷的风险 



<b>二、利用社工来进入内网 </b>

计算机“从来”不会犯错误，程序怎么写，逻辑便怎么执行；在一台计算机上怎样执行，在另外一台计
算机也同样执行。但人却会犯各种各样的错误，同一名员工在不同情况下的同一件事情上可能会犯不同的
错误，不同的员工在同一情况的同一件事情上也可能会犯不同错误。很多情况下，当红队专家发现搞系统 困难时，通常会把思路转到“搞人”（社工、钓鱼等）。很多员工对接收的木马、钓鱼邮件没有防范意识。
红队专家可针对某目标员工获取邮箱权限后，再通过此邮箱发送钓鱼邮件。大多数员工由于信任内部员工
发出的邮件，从而轻易点击了夹带在钓鱼邮件中的恶意附件。一旦员工个人电脑沦陷，红队专家可以员工
PC作为跳板实施横向内网渗透，继而攻击目标系统或其他系统、甚至攻击域控制器导致内网沦陷 

下图是群发钓鱼邮件攻击：（可以通过网上的临时邮箱来发送从而保持匿名的身份）

![image](https://s2.ax1x.com/2019/08/22/mdOVbV.png)



进入外部人员的PC机后，一般是执行以下手段来收集敏感信息:

* 翻看我的文档，是否有保存一些文档之类的新
* 浏览器历史记录
* 磁盘敏感文件
* 浏览器内存储的密码
* 受控员工的IP、账号、密码



<b>利用旁路攻击实施渗透 </b>

在有蓝队防守的红队工作中，有时总部的网站防守得较为严密，红队专家很难直面硬钢，撬开进入内
网的大门。此种情况下，通常红队不会去硬攻城门，而是会想方设法去找“下水道”，或者挖地道去迂回进
攻 ,

红队实战中发现，绝大部分企业的下属子公司之间，以及下属公司与集团总部之间的内部网络均未进
行有效隔离。很多部委单位、大型央企均习惯使用单独架设一条专用网络来打通各地区之间的内网连接，
但同时又忽视了针对此类内网的安全建设，缺乏足够有效的网络访问控制，导致子公司、分公司一旦被突
破，红队可通过内网横向渗透直接攻击到集团总部，漫游企业整个内网，攻击任意系统。 

例如A子公司位于深圳，B子公司位于广州，而总部位于北京。当A子公司或B子公司被突破后，都可以
毫无阻拦地进入到总部网络中来；而另外一种情况，A 与B子公司可能仅需要访问总部位于北京的业务系统，
而A与B不需要有业务上的往来，理论上应该限制A与B之间的网络访问。但实际情况是，一条专线内网通往
全国各地，一处沦陷可以导致处处沦陷 



![image](https://s2.ax1x.com/2019/08/22/mw9lBd.png)



另外大部分企业对开放于互联网的边界设备较为信任，如

+ VPN系统

+ 虚拟化桌面系统

+ 邮件服务系统

  

  等。考虑到此类设备通常访问内网的重要业务，为了避免影响到员工的正常使用，企业没有在其传输通道
  上增加更多的防护手段；再加上此类系统多会集成统一登录，一旦获得了某个员工的账号密码，就可以通
  过这些系统突破边界直接进入内网中来。譬如开放在内网边界的邮件服务通常

  + 缺乏审计、也未采用多因子认证，员工平时通过邮件传送大量内网的敏感信息，如服务器账户密码、重点人员通讯录等；当掌握员工账号密码后，在邮件中所获得的信息，会给红队下一步工作提供很多方便。 



<b>秘密渗透与多点潜伏 </b>

红队工作一般不会大规模使用漏洞扫描器。目前主流的WAF、IPS等防护设备都有识别漏洞扫描器的能力，一旦发现后，可能第一时间触发报警或阻断IP。因此信息收集和情报刺探是红队工作的基础，在数据积累的基础上，针对性地根据特定系统、特定平台、特定应用、特定版本，去寻找与之对应的漏洞，编写可以绕过防护设备的EXP来实施攻击操作，可以达到一击即中的目的。 

现有的很多安全设备由于自身缺陷或安全防护能力薄弱，基本上不具备对这种针对性攻击进行及时有效
发现和阻止攻击行为的能力。导致即便系统被入侵，红队获取到目标资料、数据后，被攻击单位尚未感知
到入侵行为。此外由于安全人员技术能力薄弱，无法实现对攻击行为的发现、识别，无法给出有效的攻击
阻断、漏洞溯源及系统修复策略，导致在攻击发生的很长一段时间内，对红队尚没有有效的应对措施。 



红队专家在工作中，通常不会仅仅站在一个据点上去开展渗透工作，**而是会采取不同的Webshell、后**
**门，利用不同的协议来建立不同特征的据点。因为大部分应急响应过程并不能溯源攻击源头，也未必能分**
**析完整攻击路径，缺乏联动防御。蓝队在防护设备告警时，大部分仅仅只处理告警设备中对应告警IP的服**
**务器，而忽略了对攻击链的梳理，导致尽管处理了告警，仍未能将红队排除在内网之外，红队的据点可以**
**快速“死灰复燃”**；如果某些蓝队成员专业程度不高，缺乏安全意识，导致如针对Windows服务器应急运维
的过程中，直接将自己的磁盘通过远程桌面共享挂载 ，到被告警的服务器上行为，反而可以给红队进一步攻
击蓝队成员的机会。 



实例参考PDF



## 红队眼中的防守弱点  ##

**资产混乱、隔离策略不严格** 

除了大型银行之外，很多行业对自身资产情况比较混乱，没有严格的访问控制（ACL）策略，且办公网和
互联网之间大部分相通，可以直接使远程控制程序上线。除了大型银行与互联网行业外，其他很多行业在
DMZ区和办公网之间不做或很少做隔离，网络区域划分也不严格，给了红队很多可乘之机。此外，几乎所有行业的下级单位和上级单位的业务网都可以互通。而除了大型银行之外，其他很多行业的办公网也大部分完全相通，缺少必要的分区隔离。所以，红队往往可以轻易地实现实施从子公司入侵母公司，从一个部门入侵其他部门的策略。 



**通用中间件未修复漏洞较多** 

通过中间件来看，Weblogic、Websphere、Tomcat、Apache、Nginx、IIS都有使用。Weblogic应用比
较广泛，因存在反序列化漏洞，所以常常会被作为打点和内网渗透的突破点。所有行业基本上都有对外开
放的邮件系统，可以针对邮件系统漏洞，譬如跨站漏洞、CoreMail漏洞、XXE漏洞来针对性开展攻击，也
可以通过钓鱼邮件和鱼叉邮件攻击来开展社工工作，均是比较好的突破点 



**边界设备成为进入内网的缺口** 

从边界设备来看，大部分行业都会搭建VPN设备，可以利用VPN设备的一些SQL注入、加账号、远程命
令执行等漏洞开展攻击，亦可以采取钓鱼、爆破、弱口令等方式来取得账号权限，最终绕过外网打点环
节，直接接入内网实施横向渗透 



**内网管理设备成扩大战果突破点** 

从内网系统和防护设备来看，大部分行业都有堡垒机、自动化运维、虚拟化、邮件系统和域环境，虽然这
些是安全防护的集中管理设备，但往往由于缺乏定期的维护升级，反而都可以作为开展权限扩大的突破点。 

