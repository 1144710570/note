#  内核模式和用户模式
为了避免用户应用程序访问和修改关键的操作数据,Windows使用了两种处理器访问模式（即使运行Window的底层处理器支持与多与两种模式）：
用户模式和内核模式，用户程序代码运行在用户名模式下，而操作系统代码（比如系统服务和设备驱动程序）运行在内核模式下。内核模式是指这样一种处理器执行模式：
它允许访问所有的系统内存和有的CPU指令。通过让操作系统比应用软件更高级的特权级，处理器为操作系统设计者提供了一层必要的保护，可以确保行为不正常的应用程序不会破坏系统整体的稳定性。

```
X86和x64处理架构定义了四种权级，或者成为四个环，来保护系统代码和数据不会被低级别的代码恶意地或无意改写。
Windows使用特权级0
,作为内核模式使用的是特权级3。
```
虽然每个windows进程都有自己的私有的内存空间，但是内核模式的操作系统和设备驱动程序代码共享同一根虚拟空间。虚拟内存中的每一个页面都被标记了处理器必须在上面访问模式下才可以读/写该页面。
* 只读页面（比如那些包含静态数据的页面）
* 在任何模式下都是不可写的
* 在支持不可执行内存保护的处理器上，Windows将包含数据的页面标记位不可执行，从而防止数据区域被无意地或恶意地当做代码来执行


对于在内核模式下运行的组件，32位Widnows对它们所使用的私有系统内存并不提供读写保护。一旦进入了内核模式，操作系统和设备驱动程序的代码可以完全访问系统空间的内存，也可以绕过windows安全机制直接访问该对象，对在内核模式下运行的组件必须要谨慎的设计和测试，以确保它们不会破坏系统的安全性，也不会对系统造成不稳定

![KzSO5n.md.png](https://s2.ax1x.com/2019/11/04/KzSO5n.md.png)


![KzpZ26.png](https://s2.ax1x.com/2019/11/04/KzpZ26.png)

>从用户模式到内核模式的转换（或者从内核模式回到用户模式的转换）本身并不会影响线程的调度----模式转换并不是环境切换


![KzpwZQ.png](https://s2.ax1x.com/2019/11/04/KzpwZQ.png)

# 实验：内核模式和用户模式
![KzpjdH.png](https://s2.ax1x.com/2019/11/04/KzpjdH.png)

![Kz9PQf.png](https://s2.ax1x.com/2019/11/04/Kz9PQf.png)


![KzCJu8.png](https://s2.ax1x.com/2019/11/04/KzCJu8.png)

![KzC481.png](https://s2.ax1x.com/2019/11/04/KzC481.png)

![KzCjPA.png](https://s2.ax1x.com/2019/11/04/KzCjPA.png)

![KzPla4.png](https://s2.ax1x.com/2019/11/04/KzPla4.png)

```
在鼠标移动的时候有一个名为csrss的进程的内核模式线程活动，之所以有这样的活动是因为windows子系统的内核模式原始输入线程（她赋值处理键盘和鼠标输入）
```


