# Ethernet、LAN交换及无线LAN
主题：
* 发现广播风暴或错包风暴
* 生成数协议分析
* VLAN及VLAN tagging问题分析
* 无线（wifi）问题分析

# 发现广播风暴及错包风暴
广播级错包风暴应属于通信网络中最难解决的故障之一，导致此类故障的原因有很多，比如第二层环路针对第二层的攻击网络适配器的故障或某款应用程序持续不断的在网络中发包等。

广播风暴：广播风暴是指在网络中传播的广播包的数量每秒高达千万至数万。一般而言，广播风暴发生之日便是网络瘫痪之时。

需要知道的常识
* 路由器是不会转发广播流量的
* 每个VLAN都是一个单独的广播域，VLAN之间不会交换广播流量，所以说一个VLAN也被称为一个广播域
* 任何一台LAN交换机都不会转发错包
* 除非有特殊配置，否则LAN交换机会从除接收端口以外的所有端口转发多播流量
* 只有开启多播路由功能的路由器才会转发多播流量
* 在每一个Ethernet（LAN）中，都会存数量合理的广播数据包；若非如此，主机之间将不能正常通信。但倘若广播数据包量过多，则反过来又会影响网络的正常运行


广播包数量过多跟广播风暴完全是两码事，广播包过多（比如每秒300-500个会加重网络的负担，但几乎不会降低用户对网络的使用体验）而广播风暴则会导致彻底导致网络瘫痪。


只有交换机才会存在网络风暴的情况，路由器不会
>路由器隔离广播风暴的原理：其实很简单，路由器不会将某个接口收到的广播包转发到另外一个接口所在的网络，因此，一个网段内的广播风暴不会对另一个网段造成任何影响，但是划分子网可就未必了，因为如果只是在同一个物理网络中划分的子网：比如192.168.0.0/24和192.168.1.0/24这两个网段中间并没有路由器的分割都是直接通过交换机相连的话，一旦某一台主机大量发送广播包，所有网段主机的数据通讯都会受到影响，和在一个网段的情形一样

要查明导致广播（或错包）风暴的原因
1.由于先感觉出网络慢或断网的肯定是用户，所以先问用户以下问题
* 是整个网络都有问题，还是总部网络或者某个分支结构网络有问题
* 若问题发生在总部或某个分支机构，那就继续问是整个总部或分支机构，网络有问题还是其中的某个VLAN有问题

>是生成树问题吗
>是某台设备除非了广播风暴吗
>是路由环路问题


**生成树问题**
只要生成树协议发生故障，充斥于网络中的广播包的数量将会达到每秒数千甚至上万。此时，用来抓包的wireshark可能会卡死。要想定位故障原因，只有先拔掉连接Wireshark主机抓包网卡的网线，才能让Wireshark正常显示抓到的包。然后，需登录交换机，检查STP相关配置，查看SPT的运行状态及日志输出

# 某台设备（主机）触发了广播风暴
当广播风暴是由某台设备引起时，通常具备以下典型特征：
* 广播包速率极高（数千甚至上万个/秒）
* 在绝大多数情况下，广播包都发源于单一源头，单遭到攻击除外（当网络遭受攻击时，广播包可能来源于多处）
* 广播部速率恒定，亦Wireshark所抓（广播）数据帧之间的间隔几乎完全相等

![MAx3e1.md.jpg](https://s2.ax1x.com/2019/11/07/MAx3e1.md.jpg)

![MEpoTI.png](https://s2.ax1x.com/2019/11/07/MEpoTI.png)

书上广播风暴的图IO Graphs图
![ME9FpT.md.jpg](https://s2.ax1x.com/2019/11/07/ME9FpT.md.jpg)


statics菜单名下的Conversation工具生成的Conversations窗口，可以更直接的看出
![MEEEPs.png](https://s2.ax1x.com/2019/11/07/MEEEPs.png)

![MEEZ2q.png](https://s2.ax1x.com/2019/11/07/MEEZ2q.png)

书上的图
![MEEurT.md.jpg](https://s2.ax1x.com/2019/11/07/MEEurT.md.jpg)

![MEEqyV.md.jpg](https://s2.ax1x.com/2019/11/07/MEEqyV.md.jpg)

还有一种广播风暴，其发作时间极有规律，发作时间间隔几乎保持恒定
![MEV0XV.png](https://s2.ax1x.com/2019/11/07/MEV0XV.png)

![MEVbhd.md.jpg](https://s2.ax1x.com/2019/11/07/MEVbhd.md.jpg)

![MEeKqf.md.jpg](https://s2.ax1x.com/2019/11/07/MEeKqf.md.jpg)

![MEeJRs.md.jpg](https://s2.ax1x.com/2019/11/07/MEeJRs.md.jpg)

# 生成树协议分析
常规的生成树协议被称为STP
快速生成树协议被称为RSTP
多生成树协议MST

查明STP故障的最佳途径就是登录LAN交换机

分析方法，要解决STP故障需要问STP有关的问题
* 网络中运行的是哪个版本的STP
* 在故障显现的同时，发生过网络拓扑变更的事件

# 网络中运行的是哪个版本的STP
运行常规STP的交换机会发出协议版本ID字段值为0的BPDU。
运行RSTP/MST的交换机会发出协议版本ID值为3的BPDU

![ME2jFx.md.jpg](https://s2.ax1x.com/2019/11/08/ME2jFx.md.jpg)


# 广播风暴的生成原理
![MERstx.md.jpg](https://s2.ax1x.com/2019/11/08/MERstx.md.jpg)

SW(Switch)

1.工作站A把一个广播包发送进LAN，这一广播包可以是ARP帧、NetBIOS数据包或其他任何目的地的MAC地址全部为1的以太网帧

2.由于交换机会向除接收端口以外的所有端口发送转发广播包，因此端口4收到广播包之后，SW1会从端口2、3向外发送

3.收到广播包后，SW2和SW3会分别通过端口2外发给SW4

4.SW4会把从端口2和端口3收到的广播包，再分别从端口3和端口2外发

5.现在，便诞生了2个一模一样的广播包，（广播包的发源地）SW1上的端口1和端口3也将会分贝收到一个

6.SW1再次从端口3和端口1外发，其余交换机也会无止境的复制广播包，成千上万个广播包很快就会封锁整个LAN

开发生成树的目的，是要确保LAN中午第二层环路的产生（交换机互相转发广播包形成环路，最后成为广播风暴）

启用了生成树协议的交换机，之间会在逻辑层自动构建树状拓扑（无环拓扑）。从而能起到预防环路的效果。也就是说交换机之间势必会有被生成树协议阻断的冗余链路。若在用链路时效生成树协议也能感知的到，会自动让交换机激活先前被阻断的冗余链路。

![MEh2cT.md.jpg](https://s2.ax1x.com/2019/11/08/MEh2cT.md.jpg)

![ME5Po9.md.jpg](https://s2.ax1x.com/2019/11/08/ME5Po9.md.jpg)

![ME5FiR.md.jpg](https://s2.ax1x.com/2019/11/08/ME5FiR.md.jpg)

# VLAN和VLAN tagging故障分析
在switch上配置端口镜像，把受监控VLAN的流量重定向给连接了wireshark主机的端口，如果要监控VLAN 10内传播的流量，而Wireshark主机连接的是Switch上的端口4，那么Cisco交换机上应该执行如下命令
```
monitor session 1 source vlan 10
monitor session 1 destination interface fastethernet 0/4
```
上述命令一配，便可以抓到Switch转发的VLAN10流量
>各个厂商都有自己的一套配置端口镜像命令的语法，请登录它们的官网搜索以下关键字：port mirror或mirroring

**监控通过Trunk端口传播的带VLAN标记的流量**
1.在交换机上开启端口镜像功能，让Wireshark主机直接抓取重定向的Trunk端口的数据包，看看能否看到VLAN标记的数据包

2.若否，需要配置Wireshark主机所配备的网卡。假设Wireshark主机的操作系统为Windows XP，点击开始->设置->网络连接->本地连接，在弹出的本地连接“状态”
![MEjsLn.md.jpg](https://s2.ax1x.com/2019/11/08/MEjsLn.md.jpg)

抓到的VLAN标记
![MEjvSe.md.jpg](https://s2.ax1x.com/2019/11/08/MEjvSe.md.jpg)

# 无线LAN（WIFI）故障分析
无线协议从802.11b发展到802.11g

* 信号强度：通过系统自带的RSSI工具可以看到
* 无线访问点ID：SSID
* 无线网络所使用的安全协议
* 射频类型

wifi Locator搜索当前的网络列表
![MVFC0e.png](https://s2.ax1x.com/2019/11/08/MVFC0e.png)

Rssi下的数字，数字越高，就表示相对应的无线网络信号越强
* -60dbm及以上：表示信号质量上佳
* -80dbm到-60dbm：表示无线信号较弱
* -90dbm及以下：表示无线网络信号极弱

>要让无线网络承载标准的企业级应用程序流量，信号强度不能低于-75dBm；要想跑VOIP流量的话，信号强度至少在-65dbm以上


要检查是否存在信号干扰的问题，需要安装一款名为inSSIDer的软件不但能监控指定周期内具体无线访问的信号强弱
![MVQtjH.png](https://s2.ax1x.com/2019/11/08/MVQtjH.png)

可以看见现在连接的AP属于频道4

检查是否存在以下问题
1.在同一区域是否有不同的AP运行在同一频道
2.所在区域信号强度是否不足（RSSI值低于-90dBm）

![MVQjV1.md.jpg](https://s2.ax1x.com/2019/11/08/MVQjV1.md.jpg)

>欲从另一wifi设备获取信息时（比如，为确定信号范围内的无线接入点时），移动工作站会发出probe request帧

>AP会定期发出Beacon帧，并在其中包含与其所提供的无线网络有关的信息，以宣高该无线网络的存在。信息包括：时间戳、SSID以及AP有关的其他参数。移动工作站配备的无线网卡也会持续扫描所有802.11射频信道，侦听beacon侦，以选择最佳接入点，并与之关联

![MV3KBj.md.jpg](https://s2.ax1x.com/2019/11/08/MV3KBj.md.jpg)