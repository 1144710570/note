### DMZ区 ###
<b>简介:</b>
DMZ是网络的一个区域，介于外网于内网之间的一个特殊区域。在传统意义上，安装了防火墙后，外部网络是不能访问内部网络的，要不还要防火墙干啥，假如说外部网络想要访问内部网络，比如内部网络有台WEB主机，对外提供服务，就得解决安装防火墙之后的矛盾了，一般情况下，外部网络访问内部网络有两种方法：一，主机放在内部网络LAN中，在路由器或者防火墙上做端口映射，开放路由器或者防火墙的端口和主机的端口。这种情况是在防火墙上开放了端口后，防火墙变得不安全。二，服务器放在DMZ区域，建立DMZ网络，直接在路由器或者防火墙上做DMZ设置。
![](https://s2.ax1x.com/2019/03/27/AaXYhn.png)

<b>DMZ的访问规则</b>
```
在一个用路由器连接的局域网中,我们可以将网络划分为三个区域：安全级别最高的LAN Area（内网）,安全级别中等的DMZ区域和安全级别最低的Internet区域（外网）。三个区域因担负不同的任务而拥有不同的访问策略。我们在配置一个拥有DMZ区的网络的时候通常定义以下的访问控制策略以实现DMZ区的屏障功能。
```
1.内网可以访问外网
内网的用户需要自由的访问外网。在这一策略中，防火墙需要执行NAT
```
    NAT表：（网络地址转换）私有地址在互联网上是不能路由的，这时候就需要做NAT了。
#当内网IP访问外方的时候，在经过防火墙的时候会将源地址改变成公网的IP地址，叫做：SNAT，（源地址转换）
使用的连是：POSTROUTING

     如果从外网访问内网的WEB，源地址是 公网地址，而WEB是内网地址，当经过防火墙的时候，防火墙会判断是80端口，从而修改源地址，将源地址修改成内网的WEB地址。叫做DNAT（目的地址转换）：PREROUTING连

     只要在防火墙上做了DNAT，就会将目的地址转换成私有地址，而防火墙访问自己的共有地址的时候，是不会给自己做 DNAT的
     如果外网访问内网地址的时候，防火墙会正常做DNAT的。如果防火墙访问自己的外网地址时是不会将外网共有地址转换为私有地址的。这时候就会报错。
这时候可以给防火墙加一条OUTPUT这条连
这时候在NAT里，调用了3条连，
     1、POSTROUTING：作用：源地址转换的（内网访问外网时，将内网地址转换成外网地址）
     2、PREROUTING：作用：目的地址转换（外网访问内网时，将公网地址转换成内网地址）
     3、OUTPUT ：只解决一件事情：当防火墙自己访问自己的公网地址的时候，也可以转换成私有地址。
```
2.内网可以访问DMZ
此策略使内网用户可以使用或者管理DMZ中的服务器
3.外网不能访问内网
这是防火墙的基本策略了，内网中存放的是公司内部数据，显然这些数据是不允许外网的用户进行访问的。如果要访问，就要通过VPN方式来进行
4.外网可以访问DMZ
DMZ中的服务器需要为外界提供服务，所以外网必须可以访问DMZ。同时，外网访问DMZ需要由防火墙完成对外地址到服务器实际地址的转换
5.DMZ不能访问内网
如不执行此策略，则当入侵者攻陷DMZ时，内部网络将不会受保护。　
6.DMZ不能访问外网
此条策略也有例外，比如我们的例子中，在DMZ中放置邮件服务器时，就需要访问外网，否则将不能正常工作。            
注意：数据包符合port forwarding rule的按照rule转发，如果转发的目的主机不存在将丢弃数据包，其它数据包转发至DMZ主机。

<b>DMZ与端口映射的区别</b>
NAT的DMZ和端口映射本质上是不同的。因为NAT本身是个防火墙，防止外部非授权数据包通过路由器。在没有打开DMZ功能的前提下，所有没有符合NAT表记录项的外部数据包到达路由器时，均作为非授权数据包，全部被抛弃，当路由器打开DMZ功能时，这种非授权数据包将直接转发给DMZ主机，此时，DMZ实际上是完全暴露在互联网上，可以认为是互联网上的一台主机，比较危险；若DMZ主机IP为不存在时，功能相当不开DMZ，但路由器多了个转发的负担。
端口映射只是单个外部端口与单个内部主机端口之间的映射，实际上是在NAT转换表里面建立一个静态的项目，任何符合该NAT表项的外部数据包直接转发给内部某主机.            
端口映射只是映射指定的端口，DMZ相当于映射所有的端口，并且直接把主机暴露在网关中，比端口映射方便但是不安全。
比如 作者的主机IP是192.168.1.21，在路由器上做DMZ设置，如下图：
![](http://ycxx.picp.net:8888/uploads/course_images/20181030160648322_image.png)

说明：我们APT攻击某个企业的web服务器。拿到的web服务器webshell等后门是在DMZ区域